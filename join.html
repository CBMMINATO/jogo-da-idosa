<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entrar na Sala</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>ğŸšª Entrar na Sala</h1>

    <div class="welcome-box">
      <p>Digite o cÃ³digo da sala do seu amigo</p>
    </div>

    <!-- Campo para digitar o cÃ³digo da sala -->
    <div class="input-group">
      <input type="text" id="roomCodeInput" placeholder="CÃ³digo da sala" maxlength="6" style="text-transform: uppercase;">
    </div>

    <!-- BotÃµes para entrar ou voltar -->
    <div class="button-group">
      <button onclick="joinRoom()" class="btn-primary">
        Entrar
      </button>
      <button onclick="goBack()" class="btn-secondary">
        â† Voltar
      </button>
    </div>

    <!-- Mensagem de erro ou sucesso -->
    <div id="error" class="error"></div>
  </div>

  <!-- Biblioteca do Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ConfiguraÃ§Ã£o do Supabase -->
  <script src="supabase.js"></script>
  
  <script>
    // Recupera o nome que foi salvo na tela anterior
    const playerName = localStorage.getItem('playerName');
    
    // Se nÃ£o tem nome salvo, volta para a tela inicial
    if (!playerName) {
      window.location.href = 'index.html';
    }

    // ===== VOLTAR PARA TELA INICIAL =====
    function goBack() {
      window.location.href = 'index.html';
    }

    // ===== ENTRAR NA SALA =====
    async function joinRoom() {
      const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();

      // Valida se o cÃ³digo foi preenchido
      if (!code) {
        showError('Digite o cÃ³digo da sala!');
        return;
      }

      const playerId = generateId();  // Gera ID Ãºnico para este jogador

      try {
        // Busca a sala no banco de dados
        const { data: room, error } = await supabase
          .from('rooms')
          .select('*')
          .eq('id', code)
          .single();

        // Verifica se a sala existe
        if (error || !room) {
          showError('Sala nÃ£o encontrada!');
          return;
        }

        // Verifica se a sala jÃ¡ estÃ¡ cheia (jÃ¡ tem um guest)
        if (room.guest_id) {
          showError('Sala cheia!');
          return;
        }

        // Verifica se o jogo jÃ¡ comeÃ§ou
        if (room.status !== 'waiting') {
          showError('Jogo jÃ¡ comeÃ§ou!');
          return;
        }

        // Atualiza a sala adicionando o guest (convidado)
        const { error: updateError } = await supabase
          .from('rooms')
          .update({ 
            guest_id: playerId,
            guest_name: playerName  // ğŸ†• Salva o nome do guest
          })
          .eq('id', code);

        if (updateError) throw updateError;

        // Salva informaÃ§Ãµes no navegador
        localStorage.setItem('playerId', playerId);
        localStorage.setItem('roomCode', code);
        localStorage.setItem('isHost', 'false');

        // Aguarda o host iniciar o jogo (fica monitorando em tempo real)
        waitForGameStart(code);

      } catch (err) {
        showError('Erro ao entrar: ' + err.message);
      }
    }

    // ===== AGUARDAR O JOGO COMEÃ‡AR =====
    // Fica monitorando a sala em tempo real atÃ© o host iniciar o jogo
    async function waitForGameStart(code) {
      // Mostra mensagem de sucesso
      document.getElementById('error').textContent = 'Conectado! Aguardando host iniciar...';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').style.background = 'rgba(46, 213, 115, 0.2)';
      document.getElementById('error').style.color = '#2ed573';

      // Inscreve-se para receber atualizaÃ§Ãµes da sala
      const subscription = supabase
        .channel('wait-room-' + code)
        .on('postgres_changes', 
          { 
            event: 'UPDATE',           // Monitora atualizaÃ§Ãµes
            schema: 'public', 
            table: 'rooms', 
            filter: `id=eq.${code}` 
          },
          (payload) => {
            // Quando o status mudar para 'playing', vai para a tela do jogo
            if (payload.new.status === 'playing') {
              subscription.unsubscribe();       // Cancela monitoramento
              window.location.href = 'game.html'; // Vai para o jogo
            }
          }
        )
        .subscribe();
    }

    // ===== MOSTRAR MENSAGEM DE ERRO =====
    function showError(message) {
      const el = document.getElementById('error');
      el.textContent = message;
      el.style.display = 'block';
      el.style.background = 'rgba(255, 107, 107, 0.2)';
      el.style.color = '#ff6b6b';
      
      // Esconde apÃ³s 3 segundos
      setTimeout(() => el.style.display = 'none', 3000);
    }

    // ===== GERAR ID ÃšNICO =====
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
  </script>
</body>
</html>
