<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jogando</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>‚≠ï Jogo da Velha ‚ùå</h1>

    <div class="players-box-game">
      <div class="player-card-game" id="player1Card">
        <div class="player-symbol">‚ùå</div>
        <div class="player-name-game" id="player1Name"></div>
        <div class="pieces-count" id="player1Pieces">Pe√ßas: 3</div>
      </div>
      <div class="player-card-game" id="player2Card">
        <div class="player-symbol">‚≠ï</div>
        <div class="player-name-game" id="player2Name"></div>
        <div class="pieces-count" id="player2Pieces">Pe√ßas: 3</div>
      </div>
    </div>

    <div class="status-box" id="gameStatus">Coloque suas pe√ßas!</div>
    <div class="phase-info" id="phaseInfo">Fase de Coloca√ß√£o (3 pe√ßas cada)</div>

    <div class="board" id="board"></div>

    <div class="button-group">
      <button onclick="leaveGame()" class="btn-danger">
        Sair do Jogo
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    const roomCode = localStorage.getItem('roomCode');
    const playerName = localStorage.getItem('playerName');
    const playerId = localStorage.getItem('playerId');
    const isHost = localStorage.getItem('isHost') === 'true';
    let subscription = null;
    let selectedPiece = null; // Para o modo de movimento

    if (!roomCode || !playerName || !playerId) {
      window.location.href = 'index.html';
    }

    // Configurar nomes
    if (isHost) {
      document.getElementById('player1Name').textContent = playerName + ' (Voc√™)';
      document.getElementById('player2Name').textContent = 'Oponente';
    } else {
      document.getElementById('player1Name').textContent = 'Oponente';
      document.getElementById('player2Name').textContent = playerName + ' (Voc√™)';
    }

    // Criar tabuleiro
    const boardEl = document.getElementById('board');
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement('button');
      cell.className = 'cell';
      cell.dataset.index = i;
      cell.onclick = () => handleCellClick(i);
      boardEl.appendChild(cell);
    }

    // Inscrever-se em mudan√ßas
    async function subscribeToGame() {
      await updateBoard();

      subscription = supabase
        .channel('game-' + roomCode)
        .on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomCode}` },
          async () => {
            await updateBoard();
          }
        )
        .subscribe();
    }

    async function updateBoard() {
      const { data: room } = await supabase
        .from('rooms')
        .select('*')
        .eq('id', roomCode)
        .single();

      if (!room) return;

      const board = room.board;
      const cells = document.querySelectorAll('.cell');

      // Contar pe√ßas de cada jogador
      const xPieces = board.filter(cell => cell === 'X').length;
      const oPieces = board.filter(cell => cell === 'O').length;

      // Atualizar contador de pe√ßas
      document.getElementById('player1Pieces').textContent = `Pe√ßas: ${3 - xPieces}/3`;
      document.getElementById('player2Pieces').textContent = `Pe√ßas: ${3 - oPieces}/3`;

      // Determinar fase do jogo
      const placementPhase = xPieces < 3 || oPieces < 3;

      // Atualizar c√©lulas
      cells.forEach((cell, i) => {
        const value = board[i];
        cell.textContent = value === 'X' ? '‚ùå' : value === 'O' ? '‚≠ï' : '';
        
        // Resetar classes
        cell.className = 'cell';
        if (value === 'X') cell.classList.add('x');
        if (value === 'O') cell.classList.add('o');
        
        // Se uma pe√ßa est√° selecionada, destacar
        if (selectedPiece === i) {
          cell.classList.add('selected');
        }
      });

      // Verificar vez
      const myTurn = (isHost && room.current_turn === 'host') || 
                     (!isHost && room.current_turn === 'guest');
      const mySymbol = isHost ? 'X' : 'O';

      // Atualizar status e info de fase
      if (placementPhase) {
        const myPiecesLeft = isHost ? (3 - xPieces) : (3 - oPieces);
        document.getElementById('phaseInfo').textContent = `Fase de Coloca√ß√£o (${myPiecesLeft} pe√ßas restantes)`;
        document.getElementById('gameStatus').textContent = myTurn ? 'üéÆ Sua vez - Coloque uma pe√ßa!' : '‚è≥ Oponente colocando pe√ßa...';
      } else {
        document.getElementById('phaseInfo').textContent = 'Fase de Movimento (mova suas pe√ßas)';
        if (selectedPiece !== null) {
          document.getElementById('gameStatus').textContent = 'üìç Escolha onde mover a pe√ßa!';
        } else {
          document.getElementById('gameStatus').textContent = myTurn ? 'üéÆ Sua vez - Selecione uma pe√ßa!' : '‚è≥ Oponente movendo...';
        }
      }

      // Gerenciar cliques nas c√©lulas
      cells.forEach((cell, i) => {
        const value = board[i];
        
        if (placementPhase) {
          // Fase de coloca√ß√£o: s√≥ pode clicar em c√©lulas vazias
          cell.disabled = !myTurn || value !== '';
        } else {
          // Fase de movimento
          if (!myTurn) {
            cell.disabled = true;
          } else {
            if (selectedPiece === null) {
              // Pode selecionar suas pr√≥prias pe√ßas
              cell.disabled = value !== mySymbol;
            } else {
              // Pode mover para c√©lulas vazias
              cell.disabled = value !== '';
            }
          }
        }
      });

      // Indicador visual de vez
      document.getElementById('player1Card').classList.toggle('active', room.current_turn === 'host');
      document.getElementById('player2Card').classList.toggle('active', room.current_turn === 'guest');

      // Verificar vit√≥ria
      if (room.winner) {
        const iWon = (isHost && room.winner === 'host') || (!isHost && room.winner === 'guest');
        document.getElementById('gameStatus').textContent = iWon ? 'üéâ Voc√™ venceu!' : 'üòî Voc√™ perdeu!';
        document.getElementById('gameStatus').style.background = iWon ? 'rgba(46, 213, 115, 0.3)' : 'rgba(255, 107, 107, 0.3)';
        document.getElementById('phaseInfo').textContent = 'Jogo finalizado!';
        cells.forEach(c => c.disabled = true);
        selectedPiece = null;
      }
    }

    async function handleCellClick(index) {
      const { data: room } = await supabase
        .from('rooms')
        .select('*')
        .eq('id', roomCode)
        .single();

      if (!room) return;

      const board = room.board;
      const mySymbol = isHost ? 'X' : 'O';
      const xPieces = board.filter(cell => cell === 'X').length;
      const oPieces = board.filter(cell => cell === 'O').length;
      const placementPhase = xPieces < 3 || oPieces < 3;

      if (placementPhase) {
        // FASE DE COLOCA√á√ÉO
        if (board[index] !== '') return;

        const newBoard = [...board];
        newBoard[index] = mySymbol;

        const winner = checkWinner(newBoard);
        const nextTurn = isHost ? 'guest' : 'host';

        await supabase
          .from('rooms')
          .update({ 
            board: newBoard,
            current_turn: nextTurn,
            winner: winner,
            status: winner ? 'finished' : 'playing'
          })
          .eq('id', roomCode);

      } else {
        // FASE DE MOVIMENTO
        if (selectedPiece === null) {
          // Selecionar pe√ßa para mover
          if (board[index] === mySymbol) {
            selectedPiece = index;
            updateBoard();
          }
        } else {
          // Mover pe√ßa selecionada
          if (board[index] === '') {
            const newBoard = [...board];
            newBoard[selectedPiece] = ''; // Remove da posi√ß√£o antiga
            newBoard[index] = mySymbol; // Coloca na nova posi√ß√£o
            selectedPiece = null;

            const winner = checkWinner(newBoard);
            const nextTurn = isHost ? 'guest' : 'host';

            await supabase
              .from('rooms')
              .update({ 
                board: newBoard,
                current_turn: nextTurn,
                winner: winner,
                status: winner ? 'finished' : 'playing'
              })
              .eq('id', roomCode);
          } else if (board[index] === mySymbol) {
            // Trocar sele√ß√£o de pe√ßa
            selectedPiece = index;
            updateBoard();
          }
        }
      }
    }

    function checkWinner(board) {
      const lines = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8], // Linhas
        [0, 3, 6], [1, 4, 7], [2, 5, 8], // Colunas
        [0, 4, 8], [2, 4, 6] // Diagonais
      ];

      for (let line of lines) {
        const [a, b, c] = line;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return board[a] === 'X' ? 'host' : 'guest';
        }
      }

      return null;
    }

    async function leaveGame() {
      if (subscription) subscription.unsubscribe();
      if (isHost) {
        await supabase.from('rooms').delete().eq('id', roomCode);
      }
      localStorage.clear();
      window.location.href = 'index.html';
    }

    subscribeToGame();
  </script>
</body>
</html>