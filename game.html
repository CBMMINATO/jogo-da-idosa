<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jogando</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>‚≠ï Jogo da Velha ‚ùå</h1>

    <div class="players-box-game">
      <div class="player-card-game" id="player1Card">
        <div class="player-symbol">‚ùå</div>
        <div class="player-name-game" id="player1Name"></div>
      </div>
      <div class="player-card-game" id="player2Card">
        <div class="player-symbol">‚≠ï</div>
        <div class="player-name-game" id="player2Name"></div>
      </div>
    </div>

    <div class="status-box" id="gameStatus">Sua vez!</div>

    <div class="board" id="board"></div>

    <div class="button-group">
      <button onclick="leaveGame()" class="btn-danger">
        Sair do Jogo
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    const roomCode = localStorage.getItem('roomCode');
    const playerName = localStorage.getItem('playerName');
    const playerId = localStorage.getItem('playerId');
    const isHost = localStorage.getItem('isHost') === 'true';
    let subscription = null;

    if (!roomCode || !playerName || !playerId) {
      window.location.href = 'index.html';
    }

    // Configurar nomes
    if (isHost) {
      document.getElementById('player1Name').textContent = playerName + ' (Voc√™)';
      document.getElementById('player2Name').textContent = 'Oponente';
    } else {
      document.getElementById('player1Name').textContent = 'Oponente';
      document.getElementById('player2Name').textContent = playerName + ' (Voc√™)';
    }

    // Criar tabuleiro
    const boardEl = document.getElementById('board');
    for (let i = 0; i < 9; i++) {
      const cell = document.createElement('button');
      cell.className = 'cell';
      cell.dataset.index = i;
      cell.onclick = () => makeMove(i);
      boardEl.appendChild(cell);
    }

    // Inscrever-se em mudan√ßas
    async function subscribeToGame() {
      await updateBoard();

      subscription = supabase
        .channel('game-' + roomCode)
        .on('postgres_changes', 
          { event: 'UPDATE', schema: 'public', table: 'rooms', filter: `id=eq.${roomCode}` },
          async () => {
            await updateBoard();
          }
        )
        .subscribe();
    }

    async function updateBoard() {
      const { data: room } = await supabase
        .from('rooms')
        .select('*')
        .eq('id', roomCode)
        .single();

      if (!room) return;

      const board = room.board;
      const cells = document.querySelectorAll('.cell');

      cells.forEach((cell, i) => {
        const value = board[i];
        cell.textContent = value === 'X' ? '‚ùå' : value === 'O' ? '‚≠ï' : '';
        cell.className = 'cell' + (value === 'X' ? ' x' : value === 'O' ? ' o' : '');
        cell.disabled = value !== '';
      });

      // Verificar vez
      const myTurn = (isHost && room.current_turn === 'host') || 
                     (!isHost && room.current_turn === 'guest');

      document.getElementById('gameStatus').textContent = myTurn ? 'üéÆ Sua vez!' : '‚è≥ Vez do oponente...';

      cells.forEach(cell => {
        if (cell.textContent === '') cell.disabled = !myTurn;
      });

      // Indicador visual de vez
      document.getElementById('player1Card').classList.toggle('active', room.current_turn === 'host');
      document.getElementById('player2Card').classList.toggle('active', room.current_turn === 'guest');

      // Verificar vit√≥ria
      if (room.winner) {
        const iWon = (isHost && room.winner === 'host') || (!isHost && room.winner === 'guest');
        document.getElementById('gameStatus').textContent = iWon ? 'üéâ Voc√™ venceu!' : 'üòî Voc√™ perdeu!';
        document.getElementById('gameStatus').style.background = iWon ? 'rgba(46, 213, 115, 0.3)' : 'rgba(255, 107, 107, 0.3)';
        cells.forEach(c => c.disabled = true);
      }
    }

    async function makeMove(index) {
      const { data: room } = await supabase
        .from('rooms')
        .select('*')
        .eq('id', roomCode)
        .single();

      if (!room || room.board[index] !== '') return;

      const mySymbol = isHost ? 'X' : 'O';
      const newBoard = [...room.board];
      newBoard[index] = mySymbol;

      const winner = checkWinner(newBoard);
      const nextTurn = isHost ? 'guest' : 'host';

      await supabase
        .from('rooms')
        .update({ 
          board: newBoard,
          current_turn: nextTurn,
          winner: winner,
          status: winner ? 'finished' : 'playing'
        })
        .eq('id', roomCode);
    }

    function checkWinner(board) {
      const lines = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
      ];

      for (let line of lines) {
        const [a, b, c] = line;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return board[a] === 'X' ? 'host' : 'guest';
        }
      }

      return null;
    }

    async function leaveGame() {
      if (subscription) subscription.unsubscribe();
      if (isHost) {
        await supabase.from('rooms').delete().eq('id', roomCode);
      }
      localStorage.clear();
      window.location.href = 'index.html';
    }

    subscribeToGame();
  </script>
</body>
</html>